<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç«™å†…ç•™è¨€åŒº - ESéº»å°†å½¹ç§æŸ¥è¯¢åŠ©æ‰‹</title>
    <!-- Tailwind CSS v3 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <!-- Vis.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css">
    <!-- å¼•å…¥æ•°æ®æ–‡ä»¶ -->
    <script src="data.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7e22ce', // ç´«è‰²
                        secondary: '#3b82f6', // è“è‰²
                        success: '#16a34a', // ç»¿è‰²
                        danger: '#dc2626', // çº¢è‰²
                        neutral: '#64748b', // ç°è‰²
                        dark: '#1e293b',
                        light: '#f8fafc'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-in-out',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .yaku-select {
                width: 100%;
                padding: 0.5rem 1rem;
                background-color: rgba(255, 255, 255, 0.8);
                border: 1px solid #d1d5db;
                border-radius: 0.5rem;
                outline: none;
                transition: all 0.2s ease;
            }
            .yaku-select:focus {
                border-color: #6b7280;
                box-shadow: 0 0 0 2px rgba(107, 114, 128, 0.5);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- æ ‡é¢˜åŒºåŸŸ -->
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-2">ç«™å†…ç•™è¨€åŒº</h1>
            <p class="text-gray-600">åˆ†äº«ESäººé™…å…³ç³»ï¼Œä¹Ÿå¯å‘ç«™é•¿æå‡ºåŠŸèƒ½å»ºè®®</p>
            
            <!-- é¡µé¢ç´¢å¼•å®šä½ -->
            <nav class="mt-4 bg-white rounded-lg shadow-sm p-5">
                <h2 class="font-medium text-gray-700 mb-3">é¡µé¢å¯¼èˆª</h2>
                <ul class="flex flex-wrap gap-6">
                    <li>
                        <a href="#yaku-message-section" class="text-primary hover:text-primary/80 transition-colors flex items-center">
                            <i class="fa fa-comments mr-1"></i>
                            ESäººé™…å…³ç³»ç•™è¨€
                        </a>
                    </li>
                    <li>
                        <a href="#relationship-network" class="text-primary hover:text-primary/80 transition-colors flex items-center">
                            <i class="fa fa-sitemap mr-1"></i>
                            å½¹ç§äººé™…å…³ç³»ç½‘
                        </a>
                    </li>
                    <li>
                        <a href="#admin-message-section" class="text-primary hover:text-primary/80 transition-colors flex items-center">
                            <i class="fa fa-edit mr-1"></i>
                            ç»™ç«™é•¿ç•™è¨€
                        </a>
                    </li>
                </ul>
            </nav>
        </header>
        
        <!-- ç•™è¨€æ³¨æ„äº‹é¡¹å…¬å‘Šæ  -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-8 rounded-r-lg shadow-sm">
            <div class="flex items-center">
                <i class="fa fa-exclamation-triangle text-yellow-400 mr-3 text-xl"></i>
                <div>
                    <h3 class="font-medium text-yellow-800 text-lg">ç•™è¨€æ³¨æ„äº‹é¡¹</h3>
                    <div class="text-yellow-700 mt-1 text-sm">
                        <p>ğŸ˜‹ ç•™è¨€åŠŸèƒ½æ—¨åœ¨æ±‡æ€»å¤§å®¶åƒè¿‡çš„é¦™é¦™é¥­ï¼Œå¸®åŠ©èŒæ–°å¿«é€Ÿäº†è§£æŸä¸€å°å¶åƒ/ç»„åˆ/å›¢ä½“ï¼Œæ¬¢è¿å„ä½å¤§å¨å‰æ¥åšé¥­ğŸ‘©â€ğŸ³ã€‚</p>
                        <p class="mt-1">â” ç¦æ­¢åœ¨ç•™è¨€åŒºå†…ç•™ä¸‹ä¸å‹å–„ã€å¼•æˆ˜ã€ESæ— å…³ã€æ¶‰åŠäººèº«æ”»å‡»ç­‰ä¸€ç³»åˆ—å‘è¨€ï¼Œå¦‚ç»å‘ç°ä¼šè¿›è¡Œåˆ é™¤å¤„ç†ã€‚</p>
                        <p class="mt-1">â” è¯·éµå®ˆç¤¾åŒºè§„èŒƒï¼Œå…±åŒç»´æŠ¤è‰¯å¥½çš„äº¤æµç¯å¢ƒã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è¿”å›æŒ‰é’® -->
        <div class="mb-8">
            <a href="index.html" class="bg-primary hover:bg-primary/90 text-white font-medium px-6 py-2 rounded-lg transition-all flex items-center">
                <i class="fa fa-arrow-left mr-2"></i>
                è¿”å›é¦–é¡µ
            </a>
        </div>
        
        <!-- ESäººé™…å…³ç³»ç•™è¨€ -->
        <div id="yaku-message-section" class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fa fa-comments mr-3 text-primary"></i>
                ESäººé™…å…³ç³»ç•™è¨€
            </h2>
            
            <!-- å½¹ç§é€‰æ‹© -->
            <div class="mb-6">
                <label for="yaku-select" class="block text-gray-700 font-medium mb-2">é€‰æ‹©å½¹ç§ï¼š</label>
                <select id="yaku-select" class="w-full px-4 py-2 bg-white/80 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="">è¯·é€‰æ‹©å½¹ç§</option>
                    <!-- è¿™é‡Œä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½å½¹ç§åˆ—è¡¨ -->
                </select>
            </div>
            
            <!-- Giscus è¯„è®ºåŒº -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">ç•™è¨€åŒº (ä½¿ç”¨ Giscus è¯„è®ºç³»ç»Ÿ)</h3>
                <div id="yaku-giscus" class="giscus-container">
                    <!-- Giscus è¯„è®ºå°†è‡ªåŠ¨åŠ è½½åˆ°è¿™é‡Œ -->
                </div>
            </div>
            
            <!-- æ“ä½œæç¤º -->
            <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700">
                <p><i class="fa fa-info-circle mr-2"></i>è¯·ç¡®ä¿ç•™è¨€å†…å®¹ä¸ESç›¸å…³ï¼Œæ–‡æ˜å‘è¨€ã€‚æ‚¨éœ€è¦ä½¿ç”¨ GitHub è´¦å·ç™»å½•åæ‰èƒ½ç•™è¨€ã€‚</p>
                <p class="mt-2"><i class="fa fa-tag mr-2"></i>é€‰æ‹©å½¹ç§åå‘è¡¨çš„è¯„è®ºä¼šè‡ªåŠ¨æ·»åŠ è¯¥å½¹ç§æ ‡ç­¾ï¼Œæ–¹ä¾¿æŒ‰å½¹ç§ç­›é€‰æŸ¥çœ‹ç›¸å…³ç•™è¨€ã€‚</p>
                <p class="mt-2"><i class="fa fa-filter mr-2"></i>æ¸…ç©ºå½¹ç§é€‰æ‹©å¯æŸ¥çœ‹æ‰€æœ‰ç•™è¨€ã€‚</p>
            </div>
        </div>
        
        <!-- å½¹ç§äººé™…å…³ç³»ç½‘ -->
        <div id="relationship-network" class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fa fa-sitemap mr-3 text-primary"></i>
                å½¹ç§äººé™…å…³ç³»ç½‘
            </h2>
            
            <!-- äººå‘˜é€‰æ‹© -->
            <div class="mb-6">
                <label for="person-select" class="block text-gray-700 font-medium mb-2">é€‰æ‹©äººå‘˜æŸ¥çœ‹ä»–çš„äººé™…å…³ç³»</label>
                <select id="person-select" class="yaku-select">
                    <option value="">è¯·é€‰æ‹©äººå‘˜</option>
                    <!-- è¿™é‡Œä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½äººå‘˜åˆ—è¡¨ -->
                </select>
            </div>
            
            <!-- è„‘å›¾å®¹å™¨ -->
            <div id="network" class="w-full h-[600px] border border-gray-200 rounded-lg overflow-hidden"></div>
        </div>
        
        <!-- ç»™ç«™é•¿ç•™è¨€ -->
        <div id="admin-message-section" class="bg-white rounded-xl shadow-md p-6 mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fa fa-edit mr-3 text-primary"></i>
                ç»™ç«™é•¿ç•™è¨€
            </h2>
            
            <!-- Giscus è¯„è®ºåŒº - åŠŸèƒ½å»ºè®® -->
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">åŠŸèƒ½å»ºè®® (ä½¿ç”¨ Giscus è¯„è®ºç³»ç»Ÿ)</h3>
                <div id="admin-giscus" class="giscus-container">
                    <!-- Giscus è¯„è®ºå°†è‡ªåŠ¨åŠ è½½åˆ°è¿™é‡Œ -->
                </div>
            </div>
            
            <!-- æ“ä½œæç¤º -->
            <div class="mt-6 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700">
                <p><i class="fa fa-info-circle mr-2"></i>è¯·è¯¦ç»†æè¿°æ‚¨çš„åŠŸèƒ½å»ºè®®ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ GitHub è´¦å·ç™»å½•åæ‰èƒ½ç•™è¨€ã€‚</p>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„š -->
    <footer class="bg-white py-4 px-4 border-t border-gray-200">
        <div class="container mx-auto max-w-5xl text-center text-gray-600 text-sm">
            <p>ESéº»å°†å½¹ç§æŸ¥è¯¢åŠ©æ‰‹ Â© 2025</p>
            <p>æƒ³ä¸€èµ·å‚ä¸åˆ°ç«™å†…å»ºè®¾å¯è”ç³»ï¼šaruai@foxmail.com</p>
        </div>
    </footer>
    
    <script>
        // åŠ è½½å½¹ç§åˆ—è¡¨
        function loadYakuList() {
            console.log('loadYakuListè¢«è°ƒç”¨');
            const yakuSelect = document.getElementById('yaku-select');
            console.log('yakuSelect:', yakuSelect);
            if (!yakuSelect) return;
            
            // æ¸…ç©ºç°æœ‰çš„é€‰é¡¹
            yakuSelect.innerHTML = '<option value="">è¯·é€‰æ‹©å½¹ç§ï¼ˆç©ºè¡¨ç¤ºæ˜¾ç¤ºæ‰€æœ‰ç•™è¨€ï¼‰</option>';
            
            // ä»data.jsä¸­æå–å½¹ç§åç§°å¹¶å»é‡
            const yakuNames = [...new Set(esMahjongData.map(item => item.name))].sort();
            console.log('yakuNames:', yakuNames);
            yakuNames.forEach(yaku => {
                const option = document.createElement('option');
                option.value = yaku;
                option.textContent = yaku;
                yakuSelect.appendChild(option);
            });
            
            console.log('loadYakuListæ‰§è¡Œå®Œæˆ');
        }
        
        // å½¹ç§ç­›é€‰åŠŸèƒ½
        function initYakuFilter() {
            const yakuSelect = document.getElementById('yaku-select');
            const giscusScript = document.querySelector('script[src="https://giscus.app/client.js"]');
            
            // è·å–å½“å‰URLä¸­çš„å½¹ç§å‚æ•°
            const urlParams = new URLSearchParams(window.location.search);
            const currentYaku = urlParams.get('yaku');
            
            // å¦‚æœæœ‰å½¹ç§å‚æ•°ï¼Œè®¾ç½®é€‰æ‹©æ¡†
            if (currentYaku) {
                yakuSelect.value = currentYaku;
            }
            
            // å½¹ç§é€‰æ‹©å˜åŒ–äº‹ä»¶
            yakuSelect.addEventListener('change', function() {
                const selectedYaku = this.value;
                const url = new URL(window.location.href);
                
                if (selectedYaku) {
                    url.searchParams.set('yaku', selectedYaku);
                } else {
                    url.searchParams.delete('yaku');
                }
                
                // æ›´æ–°URLè€Œä¸åˆ·æ–°é¡µé¢
                window.history.pushState({path: url.href}, '', url.href);
                
                // é‡æ–°åŠ è½½Giscusè¯„è®ºåŒº
                reloadGiscus();
            });
        }
        
        // é‡æ–°åŠ è½½Giscusè¯„è®ºåŒº
        function reloadGiscus() {
            const giscusContainer = document.getElementById('yaku-giscus');
            const adminGiscusContainer = document.getElementById('admin-giscus');
            
            // æ¸…ç©ºç°æœ‰å†…å®¹
            if (giscusContainer) {
                giscusContainer.innerHTML = '<div class="text-center py-8"><i class="fa fa-spinner fa-spin text-primary text-2xl"></i></div>';
            }
            
            if (adminGiscusContainer) {
                adminGiscusContainer.innerHTML = '<div class="text-center py-8"><i class="fa fa-spinner fa-spin text-primary text-2xl"></i></div>';
            }
            
            // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„Giscusè„šæœ¬
            const existingScripts = document.querySelectorAll('script[src="https://giscus.app/client.js"]');
            existingScripts.forEach(script => script.remove());
            
            // 1. åˆ›å»ºå½¹ç§ç•™è¨€åŒºçš„Giscusè„šæœ¬
            if (giscusContainer) {
                const yakuScript = document.createElement('script');
                yakuScript.src = 'https://giscus.app/client.js';
                yakuScript.setAttribute('data-repo', 'Arucal02/es_mahjonghelper');
                yakuScript.setAttribute('data-repo-id', 'R_kgDOQXVgkA');
                yakuScript.setAttribute('data-category', 'Comment');
                yakuScript.setAttribute('data-category-id', 'DIC_kwDOQXVgkM4CzTnw');
                yakuScript.setAttribute('data-mapping', 'pathname'); // ä½¿ç”¨è·¯å¾„åä½œä¸ºæ˜ å°„
                yakuScript.setAttribute('data-strict', '0');
                yakuScript.setAttribute('data-reactions-enabled', '1');
                yakuScript.setAttribute('data-emit-metadata', '0');
                yakuScript.setAttribute('data-input-position', 'top');
                yakuScript.setAttribute('data-theme', 'preferred_color_scheme');
                yakuScript.setAttribute('data-lang', 'zh-CN');
                yakuScript.setAttribute('data-loading', 'lazy');
                yakuScript.setAttribute('crossorigin', 'anonymous');
                yakuScript.setAttribute('async', '');
                
                // å°†è„šæœ¬æ·»åŠ åˆ°å½¹ç§ç•™è¨€åŒºå®¹å™¨
                giscusContainer.appendChild(yakuScript);
            }
            
            // 2. åˆ›å»ºç»™ç«™é•¿ç•™è¨€åŒºçš„Giscusè„šæœ¬
            if (adminGiscusContainer) {
                const adminScript = document.createElement('script');
                adminScript.src = 'https://giscus.app/client.js';
                adminScript.setAttribute('data-repo', 'Arucal02/es_mahjonghelper');
                adminScript.setAttribute('data-repo-id', 'R_kgDOQXVgkA');
                adminScript.setAttribute('data-category', 'Ideas');
                adminScript.setAttribute('data-category-id', 'DIC_kwDOQXVgkM4CzTmx');
                adminScript.setAttribute('data-mapping', 'specific'); // ä½¿ç”¨ç‰¹å®šä¸»é¢˜
                adminScript.setAttribute('data-term', 'ç»™ç«™é•¿ç•™è¨€'); // ç‰¹å®šä¸»é¢˜åç§°
                adminScript.setAttribute('data-strict', '0');
                adminScript.setAttribute('data-reactions-enabled', '1');
                adminScript.setAttribute('data-emit-metadata', '0');
                adminScript.setAttribute('data-input-position', 'top');
                adminScript.setAttribute('data-theme', 'preferred_color_scheme');
                adminScript.setAttribute('data-lang', 'zh-CN');
                adminScript.setAttribute('data-loading', 'lazy');
                adminScript.setAttribute('crossorigin', 'anonymous');
                adminScript.setAttribute('async', '');
                
                // å°†è„šæœ¬æ·»åŠ åˆ°åŠŸèƒ½å»ºè®®åŒºå®¹å™¨
                adminGiscusContainer.appendChild(adminScript);
            }
        }
        
        // Giscus è¯„è®ºç³»ç»Ÿå·²ç»é›†æˆï¼Œä¸éœ€è¦æ‰‹åŠ¨å®ç°ä¿å­˜ç•™è¨€åŠŸèƒ½
        // ä»¥ä¸‹æ˜¯åŸæœ‰çš„GitHub Issues APIç›¸å…³ä»£ç ï¼Œå·²è¢«Giscusæ›¿ä»£
        /*
        async function saveMessage(type, yaku, content, nickname = 'åŒ¿åç”¨æˆ·') {
            // åŸæœ‰ä»£ç å·²æ³¨é‡Š
        }*/
        
        // æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
        function saveMessageToLocalStorage(type, yaku, content, nickname = 'åŒ¿åç”¨æˆ·') {
            console.log('saveMessageToLocalStorageè°ƒç”¨:', { type, yaku, content, nickname });
            // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·æ ‡è¯†ï¼ˆæ¨¡æ‹ŸIPï¼‰
            let userIdentifier = localStorage.getItem('userIdentifier');
            if (!userIdentifier) {
                // ç”Ÿæˆéšæœºæ ‡è¯†ç¬¦æ¨¡æ‹Ÿç”¨æˆ·æ ‡è¯†
                userIdentifier = 'user_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('userIdentifier', userIdentifier);
                console.log('ç”Ÿæˆæ–°çš„ç”¨æˆ·æ ‡è¯†:', userIdentifier);
            }
            
            // åˆå§‹åŒ–messageså¯¹è±¡ï¼Œç¡®ä¿åŒ…å«generalç±»å‹çš„ç•™è¨€æ•°ç»„
            const messages = JSON.parse(localStorage.getItem('messages')) || { yaku: {}, admin: [], general: [] };
            console.log('ä¿å­˜å‰çš„messages:', messages);
            const timestamp = new Date().toISOString();
            const message = {
                id: Date.now(),
                content: content,
                timestamp: timestamp,
                date: new Date().toLocaleString('zh-CN'),
                nickname: nickname,
                likes: 0,
                userIdentifier: userIdentifier,
                replies: [] // æ·»åŠ å›å¤æ•°ç»„
            };
            console.log('æ–°ç•™è¨€å¯¹è±¡:', message);
            
            if (type === 'yaku') {
                if (!messages.yaku[yaku]) {
                    messages.yaku[yaku] = [];
                    console.log(`åˆ›å»ºæ–°çš„yakuç±»å‹${yaku}çš„ç•™è¨€æ•°ç»„`);
                }
                messages.yaku[yaku].push(message);
                console.log(`æ·»åŠ åˆ°yakuç±»å‹${yaku}çš„ç•™è¨€æ•°ç»„ï¼Œç°åœ¨æ•°ç»„é•¿åº¦:`, messages.yaku[yaku].length);
            } else if (type === 'admin') {
                messages.admin.push(message);
                console.log('æ·»åŠ åˆ°adminç±»å‹çš„ç•™è¨€æ•°ç»„ï¼Œç°åœ¨æ•°ç»„é•¿åº¦:', messages.admin.length);
            } else if (type === 'general') {
                if (!messages.general) {
                    messages.general = [];
                    console.log('åˆ›å»ºæ–°çš„generalç±»å‹ç•™è¨€æ•°ç»„');
                }
                messages.general.push(message);
                console.log('æ·»åŠ åˆ°generalç±»å‹çš„ç•™è¨€æ•°ç»„ï¼Œç°åœ¨æ•°ç»„é•¿åº¦:', messages.general.length);
            }
            
            localStorage.setItem('messages', JSON.stringify(messages));
            console.log('ä¿å­˜åˆ°localStorageåçš„messages:', messages);
            return message;
        }
        
        // ä¿å­˜å›å¤ - ä½¿ç”¨localStorage
        function saveReply(type, yaku, messageId, content, nickname = 'åŒ¿åç”¨æˆ·') {
            // ç›´æ¥ä½¿ç”¨localStorageçš„å®ç°
            return saveReplyToLocalStorage(type, yaku, messageId, content, nickname);
        }
        
        // æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
        function saveReplyToLocalStorage(type, yaku, messageId, content, nickname = 'åŒ¿åç”¨æˆ·') {
            // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·æ ‡è¯†ï¼ˆæ¨¡æ‹ŸIPï¼‰
            let userIdentifier = localStorage.getItem('userIdentifier');
            if (!userIdentifier) {
                // ç”Ÿæˆéšæœºæ ‡è¯†ç¬¦æ¨¡æ‹Ÿç”¨æˆ·æ ‡è¯†
                userIdentifier = 'user_' + Math.random().toString(36).substring(2, 15);
                localStorage.setItem('userIdentifier', userIdentifier);
            }
            
            const messages = JSON.parse(localStorage.getItem('messages')) || { yaku: {}, admin: [] };
            let messageList = [];
            
            if (type === 'yaku') {
                if (!messages.yaku[yaku]) {
                    return null;
                }
                messageList = messages.yaku[yaku];
            } else if (type === 'admin') {
                messageList = messages.admin;
            }
            
            const targetMessage = messageList.find(msg => msg.id === messageId);
            if (!targetMessage) {
                return null;
            }
            
            const timestamp = new Date().toISOString();
            const reply = {
                id: Date.now(),
                content: content,
                timestamp: timestamp,
                date: new Date().toLocaleString('zh-CN'),
                nickname: nickname,
                userIdentifier: userIdentifier,
                likes: 0
            };
            
            if (!targetMessage.replies) {
                targetMessage.replies = [];
            }
            
            targetMessage.replies.push(reply);
            localStorage.setItem('messages', JSON.stringify(messages));
            return reply;
        }
        
        // Giscus è¯„è®ºç³»ç»Ÿå·²ç»é›†æˆï¼Œä¸éœ€è¦æ‰‹åŠ¨å®ç°åŠ è½½ç•™è¨€åŠŸèƒ½
        // ä»¥ä¸‹æ˜¯åŸæœ‰çš„GitHub Issues APIç›¸å…³ä»£ç ï¼Œå·²è¢«Giscusæ›¿ä»£
        /*
        async function loadMessages(type, yaku = null) {
            // åŸæœ‰ä»£ç å·²æ³¨é‡Š
        }*/
        
        // æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
        function loadMessagesFromLocalStorage(type, yaku = null) {
            console.log('loadMessagesFromLocalStorageè°ƒç”¨:', { type, yaku });
            const messages = JSON.parse(localStorage.getItem('messages')) || { yaku: {}, admin: [], general: [] };
            console.log('localStorageä¸­çš„messages:', messages);
            let messageList = [];
            
            if (type === 'yaku') {
                // å³ä½¿yakuæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¹Ÿè¦å°è¯•åŠ è½½ç•™è¨€
                messageList = messages.yaku[yaku] || [];
                console.log(`yakuç±»å‹${yaku}çš„ç•™è¨€åˆ—è¡¨:`, messageList);
            } else if (type === 'admin') {
                messageList = messages.admin || [];
                console.log('adminç±»å‹çš„ç•™è¨€åˆ—è¡¨:', messageList);
            } else if (type === 'general') {
                messageList = messages.general || [];
                console.log('generalç±»å‹çš„ç•™è¨€åˆ—è¡¨:', messageList);
            }
            
            return messageList;
        }
        
        // ç‚¹èµåŠŸèƒ½ - æ”¯æŒå•ç”¨æˆ·å•æ¡ç•™è¨€åªèƒ½ç‚¹èµä¸€æ¬¡ä¸”å¯ä»¥å–æ¶ˆ
        function likeMessage(type, yaku, messageId) {
            // è·å–ç”¨æˆ·ç‚¹èµè®°å½•
            const userLikes = JSON.parse(localStorage.getItem('userLikes')) || [];
            const likeKey = `${type}-${yaku || ''}-${messageId}`;
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç»ç‚¹èµ
            const hasLiked = userLikes.includes(likeKey);
            
            const messages = JSON.parse(localStorage.getItem('messages')) || { yaku: {}, admin: [], general: [] };
            let messageList = [];
            
            if (type === 'yaku' && yaku) {
                messageList = messages.yaku[yaku] || [];
            } else if (type === 'admin') {
                messageList = messages.admin || [];
            } else if (type === 'general') {
                messageList = messages.general || [];
            }
            
            const message = messageList.find(msg => msg.id === messageId);
            if (message) {
                if (hasLiked) {
                    // å–æ¶ˆç‚¹èµ
                    message.likes = Math.max(0, message.likes - 1); // ç¡®ä¿ç‚¹èµæ•°ä¸ä¼šå°äº0
                    // ä»ç”¨æˆ·ç‚¹èµè®°å½•ä¸­ç§»é™¤
                    const updatedUserLikes = userLikes.filter(key => key !== likeKey);
                    localStorage.setItem('userLikes', JSON.stringify(updatedUserLikes));
                } else {
                    // æ·»åŠ ç‚¹èµ
                    message.likes += 1;
                    // ä¿å­˜åˆ°ç”¨æˆ·ç‚¹èµè®°å½•
                    userLikes.push(likeKey);
                    localStorage.setItem('userLikes', JSON.stringify(userLikes));
                }
                
                localStorage.setItem('messages', JSON.stringify(messages));
                
                // é‡æ–°æ¸²æŸ“ç•™è¨€åˆ—è¡¨
                let sortElementId, containerId;
                if (type === 'yaku') {
                    sortElementId = 'yaku-sort';
                    containerId = 'yaku-messages';
                } else if (type === 'admin') {
                    sortElementId = 'admin-sort';
                    containerId = 'admin-messages';
                } else if (type === 'general') {
                    sortElementId = 'general-sort';
                    containerId = 'general-messages';
                }
                const sortBy = document.getElementById(sortElementId)?.value;
                renderMessages(type, containerId, yaku, sortBy);
            }
        }
        
        // åˆ é™¤ç•™è¨€åŠŸèƒ½ - ç¡®ä¿äºŒæ¬¡ç¡®è®¤åæ‰åˆ é™¤
        // æ˜¾ç¤ºè‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(message, onConfirm, onCancel) {
            // åˆ›å»ºæ¨¡æ€æ¡†èƒŒæ™¯
            const modalBackdrop = document.createElement('div');
            modalBackdrop.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            
            // åˆ›å»ºæ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4';
            
            // åˆ›å»ºæ¶ˆæ¯å†…å®¹
            const messageElement = document.createElement('div');
            messageElement.className = 'text-gray-800 mb-6';
            messageElement.textContent = message;
            
            // åˆ›å»ºæŒ‰é’®å®¹å™¨
            const buttonsContainer = document.createElement('div');
            buttonsContainer.className = 'flex justify-end gap-4';
            
            // åˆ›å»ºå–æ¶ˆæŒ‰é’®
            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'bg-gray-200 hover:bg-gray-300 text-gray-800 px-4 py-2 rounded-lg transition-colors';
            cancelBtn.textContent = 'å–æ¶ˆ';
            cancelBtn.addEventListener('click', () => {
                document.body.removeChild(modalBackdrop);
                if (onCancel) onCancel();
            });
            
            // åˆ›å»ºç¡®è®¤æŒ‰é’®
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors';
            confirmBtn.textContent = 'ç¡®è®¤åˆ é™¤';
            confirmBtn.addEventListener('click', () => {
                document.body.removeChild(modalBackdrop);
                if (onConfirm) onConfirm();
            });
            
            // ç»„è£…æ¨¡æ€æ¡†
            buttonsContainer.appendChild(cancelBtn);
            buttonsContainer.appendChild(confirmBtn);
            modal.appendChild(messageElement);
            modal.appendChild(buttonsContainer);
            modalBackdrop.appendChild(modal);
            
            // æ·»åŠ åˆ°é¡µé¢
            document.body.appendChild(modalBackdrop);
        }

        // åˆ é™¤ç•™è¨€
        async function deleteMessage(type, yaku, messageId) {
            try {
                console.log('=== deleteMessage Debug Info ===');
                console.log('Parameters:', { type, yaku, messageId });
                console.log('MessageId type:', typeof messageId, 'MessageId value:', messageId);
                
                // å…ˆè·å–ç•™è¨€æ•°æ®ä»¥è¿›è¡Œæƒé™éªŒè¯
                const messages = await loadMessages(type, yaku);
                console.log('Loaded messages:', messages);
                console.log('Number of messages loaded:', messages.length);
                
                // æ£€æŸ¥æ¯æ¡ç•™è¨€çš„IDå­—æ®µ
                messages.forEach((msg, index) => {
                    console.log(`Message ${index} IDs:`, {
                        id: msg.id, 
                        idType: typeof msg.id,
                        messageId: msg.messageId, 
                        messageIdType: typeof msg.messageId
                    });
                });
                
                // å…¼å®¹messageIdå’Œidä¸¤ç§å­—æ®µåï¼Œå¹¶ç¡®ä¿ç±»å‹ä¸€è‡´
                const targetMessage = messages.find(msg => {
                    const matchId = String(msg.id) === String(messageId);
                    const matchMessageId = String(msg.messageId) === String(messageId);
                    console.log(`Checking message ${msg.id || msg.messageId}: idMatch=${matchId}, messageIdMatch=${matchMessageId}`);
                    return matchId || matchMessageId;
                });
                
                console.log('Found targetMessage:', targetMessage);
                
                if (!targetMessage) {
                    console.error('Target message not found!');
                    alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„ç•™è¨€');
                    return;
                }
                
                // 4. æƒé™éªŒè¯
                const currentUserIdentifier = localStorage.getItem('userIdentifier');
                const isOwnMessage = targetMessage.userIdentifier === currentUserIdentifier;
                
                let canDelete = false;
                
                if (isOwnMessage) {
                    canDelete = true;
                } else {
                    const password = prompt('è¯·è¾“å…¥ç®¡ç†å‘˜å¯†ç ä»¥åˆ é™¤ä»–äººç•™è¨€ï¼š');
                    if (password === '1351') {
                        canDelete = true;
                    } else {
                        alert('å¯†ç é”™è¯¯ï¼Œæ— æ³•åˆ é™¤ä»–äººç•™è¨€');
                        return;
                    }
                }
                
                // 5. æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡† - ç¡®ä¿äºŒæ¬¡ç¡®è®¤
                if (canDelete) {
                    const confirmText = `ç¡®å®šè¦åˆ é™¤è¿™æ¡ç•™è¨€å—ï¼Ÿ\n\n${targetMessage.content.substring(0, 20)}${targetMessage.content.length > 20 ? '...' : ''}`;
                    
                    // 6. åªæœ‰ç”¨æˆ·ç¡®è®¤åï¼Œæ‰æ‰§è¡Œåˆ é™¤æ“ä½œ
                    showConfirmDialog(confirmText, async () => {
                        try {
                            // ä½¿ç”¨localStorageåˆ é™¤ç•™è¨€ - ä¸ä¼ é€’messageså‚æ•°ï¼Œç¡®ä¿å‡½æ•°ä»localStorageé‡æ–°åŠ è½½æ­£ç¡®çš„æ•°æ®ç»“æ„
                                const deleteResult = deleteMessageFromLocalStorage(type, yaku, messageId, targetMessage);
                                
                                if (deleteResult) {
                                    // é‡æ–°æ¸²æŸ“ç•™è¨€åˆ—è¡¨
                                    let containerId, sortBy, sortElementId;
                                    if (type === 'yaku') {
                                        containerId = 'yaku-messages';
                                        sortElementId = 'yaku-sort';
                                    } else if (type === 'admin') {
                                        containerId = 'admin-messages';
                                        sortElementId = 'admin-sort';
                                    } else if (type === 'general') {
                                        containerId = 'general-messages';
                                        sortElementId = 'general-sort';
                                    } else {
                                        console.log(`ä¸æ”¯æŒçš„ç•™è¨€ç±»å‹: ${type}`);
                                        return;
                                    }
                                    
                                    sortBy = document.getElementById(sortElementId)?.value;
                                    renderMessages(type, containerId, yaku, sortBy);
                                    
                                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                                alert('ç•™è¨€å·²åˆ é™¤');
                            } else {
                                alert('æœªæ‰¾åˆ°è¦åˆ é™¤çš„ç•™è¨€');
                            }
                        } catch (error) {
                            console.error('åˆ é™¤ç•™è¨€æ—¶å‡ºé”™:', error);
                            alert('åˆ é™¤ç•™è¨€å¤±è´¥');
                        }
                    }, () => {
                        // ç”¨æˆ·å–æ¶ˆåˆ é™¤ï¼Œä¸æ‰§è¡Œä»»ä½•æ“ä½œ
                        console.log('ç”¨æˆ·å–æ¶ˆäº†åˆ é™¤æ“ä½œ');
                    });
                }
            } catch (error) {
                console.error('åˆ é™¤ç•™è¨€æ—¶å‡ºé”™:', error);
                alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            }
        }
        
        // æœ¬åœ°å­˜å‚¨ä½œä¸ºåå¤‡æ–¹æ¡ˆ
        function deleteMessageFromLocalStorage(type, yaku, messageId, targetMessage, messages) {
            // 1. è·å–å½“å‰çš„ç•™è¨€æ•°æ®
            if (!messages) {
                messages = JSON.parse(localStorage.getItem('messages')) || { yaku: {}, admin: [], general: [] };
            }
            
            // 2. ç¡®å®šç•™è¨€åˆ—è¡¨
            let messageList;
            if (type === 'yaku') {
                // ç¡®ä¿yakuç±»å‹çš„ç•™è¨€å¯¹è±¡å­˜åœ¨
                if (!messages.yaku) {
                    messages.yaku = {};
                }
                // å³ä½¿yakuæ˜¯ç©ºå­—ç¬¦ä¸²ï¼Œä¹Ÿè¦å°è¯•è·å–ç•™è¨€åˆ—è¡¨
                if (!messages.yaku[yaku]) {
                    return false;
                }
                messageList = messages.yaku[yaku];
            } else if (type === 'admin') {
                messageList = messages.admin || [];
            } else if (type === 'general') {
                // ç¡®ä¿generalç±»å‹çš„ç•™è¨€æ•°ç»„å­˜åœ¨
                messageList = messages.general || [];
                if (!messages.general) {
                    messages.general = messageList;
                }
            } else {
                console.log(`ä¸æ”¯æŒçš„ç•™è¨€ç±»å‹: ${type}`);
                return false;
            }
            
            // 3. æŸ¥æ‰¾è¦åˆ é™¤çš„ç•™è¨€ - å…¼å®¹messageIdå’Œidä¸¤ç§æƒ…å†µï¼Œå¹¶ç¡®ä¿ç±»å‹ä¸€è‡´
            const messageIndex = messageList.findIndex(msg => String(msg.messageId) === String(messageId) || String(msg.id) === String(messageId));
            if (messageIndex === -1) {
                console.log(`æœªæ‰¾åˆ°IDä¸º ${messageId} çš„ç•™è¨€`);
                return false;
            }
            
            // åˆ é™¤ç•™è¨€
            messageList.splice(messageIndex, 1);
            
            // ä¿å­˜æ›´æ–°åçš„æ•°æ®
            localStorage.setItem('messages', JSON.stringify(messages));
            
            return true;
        }
        
        // æ¸²æŸ“ç•™è¨€åˆ—è¡¨
        async function renderMessages(type, containerId, yaku = null, sortBy = 'time') {
            const container = document.getElementById(containerId);
            const loadingIndicator = document.getElementById(`${containerId.replace('-messages', '')}-loading-indicator`);
             
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            if (loadingIndicator) {
                loadingIndicator.classList.remove('hidden');
            } else {
                container.innerHTML = '<p class="text-gray-500 text-center py-8"><i class="fa fa-spinner fa-spin mr-2"></i>æ­£åœ¨åŠ è½½ç•™è¨€...</p>';
            }
             
            try {
                // åŠ è½½ç•™è¨€
                let messages = await loadMessages(type, yaku);
                 
                // æ’åºç•™è¨€
                if (sortBy === 'likes') {
                    messages.sort((a, b) => b.likes - a.likes);
                } else {
                    messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                }
                 
                if (messages.length === 0) {
                    container.innerHTML = '<p class="text-gray-500 text-center py-8">æš‚æ— ç•™è¨€</p>';
                    return;
                }
                 
                // è·å–ç”¨æˆ·ç‚¹èµè®°å½•
                const userLikes = JSON.parse(localStorage.getItem('userLikes')) || [];
                 
                container.innerHTML = messages.map(message => {
                    const likeKey = `${type}-${yaku || ''}-${message.id}`;
                    const hasLiked = userLikes.includes(likeKey);
                     
                    // æ¸²æŸ“å›å¤åˆ—è¡¨
                    const repliesHtml = message.replies && message.replies.length > 0 ? `
                        <div class="mt-4 pl-4 border-l-2 border-gray-200 space-y-3">
                            ${message.replies.map(reply => `
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="font-medium text-primary text-sm">${reply.nickname || 'åŒ¿åç”¨æˆ·'}</span>
                                        <span class="text-xs text-gray-500">${reply.date}</span>
                                    </div>
                                    <div class="text-gray-700 text-sm whitespace-pre-wrap">${reply.content}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '';
                     
                    return `
                        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-semibold text-primary">${message.nickname || 'åŒ¿åç”¨æˆ·'}</span>
                                <span class="text-sm text-gray-500">${message.date}</span>
                            </div>
                            <div class="text-gray-800 mb-3 whitespace-pre-wrap">${message.content}</div>
                             
                            <!-- å›å¤åˆ—è¡¨ -->
                            ${repliesHtml}
                             
                            <!-- å›å¤è¡¨å• -->
                            <div class="mt-4">
                                <button onclick="toggleReplyForm(${message.id})" class="text-sm text-primary hover:text-primary/80 transition-colors flex items-center">
                                    <i class="fa fa-reply mr-1"></i>
                                    å›å¤
                                </button>
                                <form id="reply-form-${message.id}" class="hidden mt-2" onsubmit="submitReply(event, '${type}', '${yaku || ''}', ${message.id})">
                                    <textarea name="reply-content" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm" placeholder="å†™ä¸‹ä½ çš„å›å¤..."></textarea>
                                    <div class="flex justify-between items-center mt-2">
                                        <input type="text" name="reply-nickname" placeholder="ä½ çš„æ˜µç§° (å¯é€‰)" class="px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary text-sm w-48">
                                        <button type="submit" class="bg-primary hover:bg-primary/90 text-white px-4 py-1 rounded-lg text-sm transition-colors">
                                            å‘é€å›å¤
                                        </button>
                                    </div>
                                </form>
                            </div>
                             
                            <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-100">
                                <button onclick="likeMessage('${type}', '${yaku || ''}', ${message.id})" 
                                        class="flex items-center transition-colors ${hasLiked ? 'text-red-500' : 'text-gray-500 hover:text-red-500'}">
                                    <i class="fa fa-thumbs-up mr-1"></i>
                                    <span>${message.likes}</span>
                                </button>
                                <!-- åªå¯¹è‡ªå·±çš„ç•™è¨€æ˜¾ç¤ºåˆ é™¤æŒ‰é’® -->
                                ${message.userIdentifier === localStorage.getItem('userIdentifier') ? `
                                <button class="delete-btn text-gray-500 hover:text-red-500 transition-colors"
                                        data-type="${type}"
                                        data-yaku="${yaku || ''}"
                                        data-message-id="${message.id}">
                                    <i class="fa fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                 
                // æ¸²æŸ“å®Œæˆåï¼Œç¡®ä¿å…¨å±€äº‹ä»¶ç›‘å¬å™¨èƒ½å¤Ÿå¤„ç†åˆ é™¤æŒ‰é’®ç‚¹å‡»
            } catch (error) {
                console.error('æ¸²æŸ“ç•™è¨€å¤±è´¥:', error);
                container.innerHTML = '<p class="text-red-500 text-center py-8">åŠ è½½ç•™è¨€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>';
            } finally {
                // éšè—åŠ è½½çŠ¶æ€
                if (loadingIndicator) {
                    loadingIndicator.classList.add('hidden');
                }
            }
        }
        
        // åˆ‡æ¢å›å¤è¡¨å•æ˜¾ç¤º/éšè—
        function toggleReplyForm(messageId) {
            const form = document.getElementById(`reply-form-${messageId}`);
            if (form) {
                form.classList.toggle('hidden');
            }
        }
        
        // æäº¤å›å¤
        function submitReply(event, type, yaku, messageId) {
            event.preventDefault();
            const form = event.target;
            const replyContent = form['reply-content'].value.trim();
            const replyNickname = form['reply-nickname'].value.trim() || 'åŒ¿åç”¨æˆ·';
            
            if (!replyContent) {
                alert('è¯·è¾“å…¥å›å¤å†…å®¹');
                return;
            }
            
            // è·å–å½“å‰æ’åºæ–¹å¼
            const currentSortBy = type === 'yaku' ? document.getElementById('yaku-sort')?.value || 'time' : document.getElementById('admin-sort')?.value || 'time';
            
            // ä¿å­˜å›å¤
            const reply = saveReply(type, yaku, messageId, replyContent, replyNickname);
            if (reply) {
                // é‡æ–°æ¸²æŸ“ç•™è¨€åˆ—è¡¨
                const containerId = type === 'yaku' ? 'yaku-messages' : 'admin-messages';
                renderMessages(type, containerId, yaku, currentSortBy);
                
                // æ¸…ç©ºè¡¨å•
                form.reset();
                form.classList.add('hidden');
            }
        }
        
        // å…¨å±€å˜é‡
        let network, allPersons = [];
        
        // äº‹ä»¶ç›‘å¬ - åˆå¹¶æ‰€æœ‰åˆå§‹åŒ–ä»£ç åˆ°ä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('é¡µé¢DOMåŠ è½½å®Œæˆ');
            console.log('esMahjongDataæ˜¯å¦å­˜åœ¨:', typeof esMahjongData !== 'undefined');
            console.log('esMahjongDataé•¿åº¦:', esMahjongData ? esMahjongData.length : 0);
            
            // åŠ è½½å½¹ç§åˆ—è¡¨ç”¨äºç­›é€‰
            loadYakuList();
            loadPersonList(); // åŠ è½½äººå‘˜åˆ—è¡¨ç”¨äºå½¹ç§å…³ç³»ç½‘
            
            // åŠ è½½Giscusè¯„è®ºåŒº
            reloadGiscus();
            
            // åˆå§‹åŒ–å½¹ç§ç­›é€‰åŠŸèƒ½
            initYakuFilter();
            
            // æ¸²æŸ“ç®¡ç†å‘˜ç•™è¨€
            // renderMessages('admin', 'admin-messages');
            
            // å½¹ç§é€‰æ‹©å˜åŒ–æ—¶åŠ è½½å¯¹åº”ç•™è¨€
            const yakuSelect = document.getElementById('yaku-select');
            if (yakuSelect) {
                yakuSelect.addEventListener('change', function() {
                    const yaku = this.value;
                    if (yaku) {
                        const sortBy = document.getElementById('yaku-sort')?.value || 'time';
                        renderMessages('yaku', 'yaku-messages', yaku, sortBy);
                    } else {
                        document.getElementById('yaku-messages').innerHTML = '<p class="text-gray-500 text-center py-8">è¯·é€‰æ‹©å½¹ç§æŸ¥çœ‹ç•™è¨€</p>';
                    }
                });
            }
            
            // äººå‘˜é€‰æ‹©å˜åŒ–æ—¶æ¸²æŸ“è„‘å›¾
            const personSelect = document.getElementById('person-select');
            if (personSelect) {
                personSelect.addEventListener('change', function() {
                    const person = this.value;
                    if (person) {
                        renderNetwork(person);
                    } else {
                        const container = document.getElementById('network');
                        container.innerHTML = '<p class="text-gray-500 text-center py-16">è¯·é€‰æ‹©äººå‘˜æŸ¥çœ‹äººé™…å…³ç³»è„‘å›¾</p>';
                        if (network) {
                            network.destroy();
                            network = null;
                        }
                    }
                });
            }
            
            // å½¹ç§ç•™è¨€æäº¤
            const yakuSubmitBtn = document.getElementById('yaku-submit');
            if (yakuSubmitBtn) {
                yakuSubmitBtn.addEventListener('click', async function() {
                    const yakuSelect = document.getElementById('yaku-select');
                    const messageInput = document.getElementById('yaku-message');
                    const nicknameInput = document.getElementById('yaku-nickname');
                    const submitBtn = this;
                    const loadingIcon = document.getElementById('yaku-loading');
                    
                    const yaku = yakuSelect.value;
                    const content = messageInput.value.trim();
                    const nickname = nicknameInput.value.trim() || 'åŒ¿åç”¨æˆ·';
                    
                    if (!yaku) {
                        alert('è¯·å…ˆé€‰æ‹©å½¹ç§');
                        return;
                    }
                    
                    if (!content) {
                        alert('è¯·è¾“å…¥ç•™è¨€å†…å®¹');
                        return;
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    submitBtn.disabled = true;
                    loadingIcon.classList.remove('hidden');
                    
                    try {
                        // ä¿å­˜ç•™è¨€
                        console.log('å‡†å¤‡ä¿å­˜ç•™è¨€:', { type: 'yaku', yaku, content, nickname });
                        const savedMessage = await saveMessage('yaku', yaku, content, nickname);
                        console.log('ç•™è¨€ä¿å­˜æˆåŠŸ:', savedMessage);
                        
                        // æ¸²æŸ“æ›´æ–°åçš„ç•™è¨€åˆ—è¡¨
                        const sortBy = document.getElementById('yaku-sort')?.value || 'time';
                        console.log('å‡†å¤‡æ¸²æŸ“ç•™è¨€åˆ—è¡¨:', { type: 'yaku', containerId: 'yaku-messages', yaku, sortBy });
                        renderMessages('yaku', 'yaku-messages', yaku, sortBy);
                        
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        messageInput.value = '';
                        
                        alert('ç•™è¨€æäº¤æˆåŠŸï¼');
                    } catch (error) {
                        console.error('æäº¤ç•™è¨€å¤±è´¥:', error);
                        alert('ç•™è¨€æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        // éšè—åŠ è½½çŠ¶æ€
                        submitBtn.disabled = false;
                        loadingIcon.classList.add('hidden');
                    }
                });
            }
            
            // ç®¡ç†å‘˜ç•™è¨€æäº¤ - å·²è¢« Giscus æ›¿ä»£
            /*
            const adminSubmitBtn = document.getElementById('admin-submit');
            if (adminSubmitBtn) {
                adminSubmitBtn.addEventListener('click', async function() {
                    const messageInput = document.getElementById('admin-message');
                    const nicknameInput = document.getElementById('admin-nickname');
                    const submitBtn = this;
                    const loadingIcon = document.getElementById('admin-loading');
                    
                    const content = messageInput.value.trim();
                    const nickname = nicknameInput.value.trim() || 'åŒ¿åç”¨æˆ·';
                    
                    if (!content) {
                        alert('è¯·è¾“å…¥å»ºè®®å†…å®¹');
                        return;
                    }
                    
                    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                    submitBtn.disabled = true;
                    loadingIcon.classList.remove('hidden');
                    
                    try {
                        // ä¿å­˜ç•™è¨€
                        await saveMessage('admin', null, content, nickname);
                        
                        // æ¸²æŸ“æ›´æ–°åçš„ç•™è¨€åˆ—è¡¨
                        const sortBy = document.getElementById('admin-sort')?.value || 'time';
                        renderMessages('admin', 'admin-messages', null, sortBy);
                        
                        // æ¸…ç©ºè¾“å…¥æ¡†
                        messageInput.value = '';
                        
                        alert('å»ºè®®æäº¤æˆåŠŸï¼');
                    } catch (error) {
                        console.error('æäº¤å»ºè®®å¤±è´¥:', error);
                        alert('å»ºè®®æäº¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    } finally {
                        // éšè—åŠ è½½çŠ¶æ€
                        submitBtn.disabled = false;
                        loadingIcon.classList.add('hidden');
                    }
                });
            }
            */
            
            // æ’åºæ–¹å¼å˜åŒ–æ—¶é‡æ–°æ¸²æŸ“ç•™è¨€
            const yakuSort = document.getElementById('yaku-sort');
            if (yakuSort) {
                yakuSort.addEventListener('change', function() {
                    const yaku = document.getElementById('yaku-select').value;
                    if (yaku) {
                        renderMessages('yaku', 'yaku-messages', yaku, this.value);
                    }
                });
            }
            
            // ç®¡ç†å‘˜æ’åº - å·²è¢« Giscus æ›¿ä»£
            /*
            const adminSort = document.getElementById('admin-sort');
            if (adminSort) {
                adminSort.addEventListener('change', function() {
                    renderMessages('admin', 'admin-messages', null, this.value);
                });
            }
            */
            
            // ä¸ºæ‰€æœ‰åˆ é™¤æŒ‰é’®æ·»åŠ å…¨å±€äº‹ä»¶ç›‘å¬å™¨ï¼ˆäº‹ä»¶å§”æ‰˜ï¼‰
            document.addEventListener('click', function(e) {
                if (e.target && e.target.closest('.delete-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    const btn = e.target.closest('.delete-btn');
                    const type = btn.getAttribute('data-type');
                    const yaku = btn.getAttribute('data-yaku');
                    // ä¸è½¬æ¢ä¸ºæ•´æ•°ï¼Œä¿æŒå­—ç¬¦ä¸²ç±»å‹ä»¥å…¼å®¹ç•™è¨€æ•°æ®ä¸­çš„idå­—æ®µ
                    const messageId = btn.getAttribute('data-message-id');
                    deleteMessage(type, yaku, messageId);
                }
            });
        });
        
        // åŠ è½½æ‰€æœ‰äººå‘˜
        function loadPersonList() {
            console.log('loadPersonListè¢«è°ƒç”¨');
            const select = document.getElementById('person-select');
            console.log('person-select:', select);
            if (!select) return;
            
            // ä»esMahjongDataä¸­æå–æ‰€æœ‰å”¯ä¸€äººå‘˜ï¼Œè¿‡æ»¤æ‰äº‹åŠ¡æ‰€å’Œå›¢ä½“
            const personSet = new Set();
            const officeGroupNames = new Set(['STAR PRO', 'NEW DIMENSION', 'COSMIC PRODUCTION', 'COS PRO', 'NEW DI', 'Rhythm Link', 'Rhythm Linkï¼ˆæå­æ—ï¼‰', 'fine', 'Trickstar', 'æµæ˜Ÿé˜Ÿ', 'ALKALOID', 'UNDEAD', 'Undead', 'Knights', 'knights', 'Valkyrie', '2wink', 'Switch', 'switch', 'MaM', 'mam', 'MAM', 'Crazy:B', 'Eden', 'DoubleFace', 'Ra*bits', 'Special for Princess!ï¼ˆSpriï¼‰']);
            
            esMahjongData.forEach(yaku => {
                // æ£€æŸ¥yaku.membersæ˜¯å¦å­˜åœ¨ä¸”æ˜¯æ•°ç»„
                if (yaku.members && Array.isArray(yaku.members)) {
                    yaku.members.forEach(member => {
                        // è¿‡æ»¤æ‰ç©ºæˆå‘˜ã€å ä½ç¬¦ä»¥åŠäº‹åŠ¡æ‰€å’Œå›¢ä½“åç§°
                        if (member && member !== '-' && member.trim() !== '' && !officeGroupNames.has(member)) {
                            personSet.add(member);
                        }
                    });
                }
            });
            
            allPersons = Array.from(personSet).sort();
            console.log('allPersons:', allPersons);
            
            // å¡«å……äººå‘˜é€‰æ‹©ä¸‹æ‹‰æ¡†
            select.innerHTML = '<option value="">è¯·é€‰æ‹©äººå‘˜</option>';
            allPersons.forEach(person => {
                const option = document.createElement('option');
                option.value = person;
                option.textContent = person;
                select.appendChild(option);
            });
            console.log('loadPersonListæ‰§è¡Œå®Œæˆ');
        }
        
        // ç”Ÿæˆè„‘å›¾æ•°æ®
        function generateNetworkData(selectedPerson) {
            if (!selectedPerson) return { nodes: [], edges: [] };
            
            // åˆ†ç±»é¢œè‰²æ˜ å°„ - ä½¿ç”¨æ›´ç¾è§‚çš„é…è‰²æ–¹æ¡ˆ
            const categoryColors = {
                'è¿½å¿†æ ¡å›­': '#FF6B6B',
                'æ´—ç‰Œ': '#4ECDC4',
                'å…„å¼Ÿ': '#45B7D1',
                'é˜Ÿé•¿': '#96CEB4',
                'äº‹åŠ¡æ‰€ä»£è¡¨': '#FFEAA7',
                'å®¿èˆ': '#DDA0DD',
                'å…¶ä»–': '#98D8C8'
            };
            
            // å®šä¹‰éœ€è¦è¿‡æ»¤çš„äº‹åŠ¡æ‰€å’Œå›¢ä½“åç§°
            const officeGroupNames = new Set(['STAR PRO', 'NEW DIMENSION', 'COSMIC PRODUCTION', 'COS PRO', 'NEW DI', 'Rhythm Link', 'Rhythm Linkï¼ˆæå­æ—ï¼‰', 'fine', 'Trickstar', 'æµæ˜Ÿé˜Ÿ', 'ALKALOID', 'UNDEAD', 'Undead', 'Knights', 'knights', 'Valkyrie', '2wink', 'Switch', 'switch', 'MaM', 'mam', 'MAM', 'Crazy:B', 'Eden', 'DoubleFace', 'Ra*bits', 'Special for Princess!ï¼ˆSpriï¼‰']);
            
            const nodes = [];
            const edges = [];
            const addedNodes = new Set();
            
            // æ·»åŠ ä¸­å¿ƒèŠ‚ç‚¹ï¼ˆé€‰ä¸­çš„äººå‘˜ï¼‰- æ ·å¼ç±»ä¼¼ç¤ºä¾‹å›¾çš„ä¸­å¿ƒäººç‰©
            nodes.push({
                id: selectedPerson,
                label: selectedPerson,
                color: {
                    background: '#1E3A8A', // æ·±è“è‰² - æ›´åè°ƒçš„ä¸»è‰²è°ƒ
                    border: '#1E3A8A',
                    highlight: {
                        background: '#3B82F6',
                        border: '#2563EB'
                    }
                },
                size: 45, // å¢å¤§ä¸­å¿ƒèŠ‚ç‚¹
                font: { 
                    size: 18, 
                    color: '#ffffff', // ç™½è‰²æ–‡å­—ï¼Œæé«˜å¯è¯»æ€§
                    face: 'Arial',
                    weight: 'bold'
                },
                shape: 'circle',
                shadow: {
                    enabled: true,
                    color: 'rgba(0,0,0,0.4)',
                    size: 15
                },
                borderWidth: 4 // åŠ ç²—è¾¹æ¡†
            });
            addedNodes.add(selectedPerson);
            
            // ä¸ºæ¯ä¸ªå½¹ç§ç±»å‹åˆ›å»ºä¸€ä¸ªåˆ†ç»„èŠ‚ç‚¹
            const categoryNodes = new Map();
            
            // éå†æ‰€æœ‰å½¹ç§ï¼Œæ‰¾åˆ°ä¸é€‰ä¸­äººå‘˜ç›¸å…³çš„å½¹ç§
            esMahjongData.forEach(yaku => {
                // ç¡®ä¿yaku.memberså­˜åœ¨
                if (yaku.members && yaku.members.includes(selectedPerson)) {
                    // ç¡®ä¿å½¹ç§ç±»å‹èŠ‚ç‚¹å­˜åœ¨
                    if (!categoryNodes.has(yaku.category)) {
                        const categoryId = `category_${yaku.category}`;
                        categoryNodes.set(yaku.category, categoryId);
                        nodes.push({
                            id: categoryId,
                            label: yaku.category,
                            color: {
                                background: '#9B59B6', // ç´«è‰² - äºŒçº§æ ‡ç­¾
                                border: '#7B1FA2',
                                highlight: {
                                    background: '#7B1FA2',
                                    border: '#6A1B9A'
                                }
                            },
                            size: 80, // è°ƒæ•´å°ºå¯¸
                            font: {
                                size: 12,
                                color: '#ffffff',
                                face: 'Arial',
                                weight: 'bold'
                            },
                            shape: 'box',
                            shadow: {
                                enabled: true,
                                color: 'rgba(0,0,0,0.3)',
                                size: 10
                            },
                            margin: 8,
                            widthConstraint: {
                                minimum: 70,
                                maximum: 150
                            },
                            borderWidth: 2
                        });
                        addedNodes.add(categoryId);
                    }
                    
                    const categoryId = categoryNodes.get(yaku.category);
                    
                    // æ·»åŠ å½¹ç§èŠ‚ç‚¹ - ç®€åŒ–æ ·å¼
                    const yakuId = `yaku_${yaku.name}`;
                    if (!addedNodes.has(yakuId)) {
                        // å½¹ç§èŠ‚ç‚¹ä¸éœ€è¦åœ¨å›¾ä¸­æ˜¾ç¤ºï¼Œåªéœ€è¦è¿æ¥å…³ç³»
                        // æˆ‘ä»¬å¯ä»¥å°†å½¹ç§ä½œä¸ºè¾¹çš„æ ‡ç­¾ï¼Œè¿™æ ·æ›´ç®€æ´
                        addedNodes.add(yakuId);
                    }
                    
                    // æ·»åŠ è¾¹ï¼šäººå‘˜ -> å½¹ç§ç±»å‹
                    edges.push({
                        from: selectedPerson,
                        to: categoryId,
                        color: {
                            color: '#3B82F6', // æµ…è“è‰² - ä¸ä¸€çº§æ ‡ç­¾åè°ƒ
                            highlight: '#2563EB',
                            opacity: 0.7
                        },
                        width: 3,
                        smooth: true,
                        arrowStrikethrough: false
                    });
                    
                    // ç§»é™¤å½¹ç§èŠ‚ç‚¹ï¼Œæ‰€ä»¥ä¸å†éœ€è¦è¿™æ¡è¾¹
                    
                    // æ·»åŠ è¾¹ï¼šå½¹ç§ç±»å‹ -> å…¶ä»–æˆå‘˜ï¼Œç›´æ¥è¿æ¥ï¼Œè·³è¿‡å½¹ç§èŠ‚ç‚¹
                    yaku.members.forEach(member => {
                        // è¿‡æ»¤æ‰ç©ºæˆå‘˜ã€å ä½ç¬¦ã€é€‰ä¸­äººå‘˜ä»¥åŠäº‹åŠ¡æ‰€å’Œå›¢ä½“åç§°
                        if (member && member !== '-' && member !== selectedPerson && member.trim() !== '' && !officeGroupNames.has(member)) {
                            if (!addedNodes.has(member)) {
                                nodes.push({
                                    id: member,
                                    label: member,
                                    color: {
                                        background: '#3498DB', // è“è‰² - ä¸‰çº§æ ‡ç­¾
                                        border: '#2980B9',
                                        highlight: {
                                            background: '#2196F3',
                                            border: '#1976D2'
                                        }
                                    },
                                    size: 25, // è°ƒæ•´æˆå‘˜èŠ‚ç‚¹å¤§å°
                                    font: {
                                        size: 11,
                                        color: '#ffffff',
                                        face: 'Arial',
                                        weight: 'bold'
                                    },
                                    shape: 'circle',
                                    shadow: {
                                        enabled: true,
                                        color: 'rgba(0,0,0,0.2)',
                                        size: 8
                                    },
                                    borderWidth: 2
                                });
                                addedNodes.add(member);
                            }
                            
                            edges.push({
                                from: categoryId,
                                to: member,
                                color: {
                                    color: '#6c757d',
                                    highlight: '#495057',
                                    opacity: 0.7
                                },
                                width: 2,
                                smooth: {
                                    type: 'curvedCCW',
                                    roundness: 0.3
                                },
                                style: 'solid',
                                arrowStrikethrough: false,
                                label: yaku.name, // åœ¨è¾¹ä¸Šæ˜¾ç¤ºå½¹ç§åç§°
                                font: {
                                    size: 10,
                                    color: '#555555',
                                    face: 'Arial'
                                },
                                labelHighlightBold: true
                            });
                        }
                    });
                }
            });
            
            return { nodes, edges };
        }
        
        // æ¸²æŸ“è„‘å›¾
        function renderNetwork(selectedPerson) {
            const container = document.getElementById('network');
            const data = generateNetworkData(selectedPerson);
            
            // æ£€æŸ¥æ•°æ®æ˜¯å¦ä¸ºç©º
            if (!data.nodes || data.nodes.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-16">æœªæ‰¾åˆ°è¯¥äººå‘˜çš„äººé™…å…³ç³»æ•°æ®</p>';
                if (network) {
                    network.destroy();
                    network = null;
                }
                return;
            }
            
            const options = {
                // ç”»å¸ƒæ ·å¼
                width: '100%',
                height: '100%',
                background: {
                    color: 'rgba(255, 255, 255, 1)'
                },
                
                // èŠ‚ç‚¹æ ·å¼
                nodes: {
                    borderWidth: 2,
                    borderWidthSelected: 3,
                    shadow: {
                        enabled: true,
                        size: 10,
                        x: 3,
                        y: 3,
                        color: 'rgba(0,0,0,0.2)'
                    },
                    chosen: {
                        node: function(values, id, selected, hovering) {
                            values.shadow = true;
                            if (hovering) {
                                values.shadow.size = 15;
                            }
                        }
                    }
                },
                
                // è¾¹æ ·å¼
                edges: {
                    smooth: {
                        type: 'cubicBezier',
                        forceDirection: 'vertical',
                        roundness: 0.4
                    },
                    color: {
                        opacity: 0.8
                    },
                    arrows: {
                        to: {
                            enabled: true,
                            scaleFactor: 0.8
                        }
                    },
                    chosen: {
                        edge: function(values, id, selected, hovering) {
                            if (hovering) {
                                values.width = values.width * 1.5;
                                values.color.opacity = 1;
                            }
                        }
                    }
                },
                
                // ç‰©ç†å¼•æ“ - ä¼˜åŒ–é…ç½®ä»¥è·å¾—æ›´åƒç¤ºä¾‹å›¾çš„å¸ƒå±€
                physics: {
                    barnesHut: {
                        gravitationalConstant: -50000, // å¢åŠ å¼•åŠ›ä½¿èŠ‚ç‚¹æ›´é›†ä¸­
                        centralGravity: 0.7, // å¢åŠ ä¸­å¿ƒå¼•åŠ›
                        springLength: 150, // ç¼©çŸ­å¼¹ç°§é•¿åº¦
                        springConstant: 0.05,
                        damping: 0.15,
                        avoidOverlap: 0.8 // å¢åŠ é¿å…é‡å çš„å€¼
                    },
                    maxVelocity: 15,
                    minVelocity: 0.1,
                    solver: 'barnesHut',
                    timestep: 0.3,
                    adaptiveTimestep: true
                },
                
                // ç¦ç”¨å±‚æ¬¡å¸ƒå±€ï¼Œæ”¹ç”¨åŠ¨æ€åŠ›å¯¼å‘å¸ƒå±€æ›´é€‚åˆå…³ç³»å›¾
                layout: {
                    randomSeed: 42, // å›ºå®šéšæœºç§å­ä»¥è·å¾—ä¸€è‡´çš„å¸ƒå±€
                    improvedLayout: true
                },
                
                // äº¤äº’è®¾ç½®
                interaction: {
                    hover: true,
                    hoverConnectedEdges: true,
                    selectable: true,
                    selectConnectedEdges: true,
                    zoomView: true,
                    dragView: true,
                    dragNodes: true,
                    multiselect: true,
                    keyboard: {
                        enabled: true
                    },
                    tooltipDelay: 200,
                    hideEdgesOnDrag: false
                },
                
                // é…ç½®é€‰é¡¹
                configure: {
                    enabled: false
                }
            };
            
            if (network) {
                network.destroy();
            }
            
            network = new vis.Network(container, data, options);
            
            // æ·»åŠ ç¼©æ”¾æ§åˆ¶
            network.on('afterDrawing', function() {
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰ç¼©æ”¾æ§åˆ¶
            });
            
            // ç½‘ç»œç¨³å®šåè‡ªåŠ¨è°ƒæ•´è§†å›¾å¤§å°
            network.once('stabilized', function() {
                network.fit();
            });
        }
        
        // æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨å·²æ•´åˆåˆ°DOMContentLoadedäº‹ä»¶ä¸­
    </script>
  
  <!-- è¿”å›é¡¶éƒ¨/åº•éƒ¨æ¼‚æµ®çª— -->
  <div class="fixed right-4 bottom-4 flex flex-col gap-2 z-50 opacity-20 hover:opacity-100 transition-opacity duration-300">
    <button id="scrollToTop" class="bg-primary text-white rounded-full p-3 shadow-lg hover:bg-primary/90 transition-colors duration-300">
      <i class="fas fa-arrow-up"></i>
    </button>
    <button id="scrollToBottom" class="bg-primary text-white rounded-full p-3 shadow-lg hover:bg-primary/90 transition-colors duration-300">
      <i class="fas fa-arrow-down"></i>
    </button>
  </div>
  
  <script>
    // è¿”å›é¡¶éƒ¨/åº•éƒ¨åŠŸèƒ½
    document.getElementById('scrollToTop').addEventListener('click', function() {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
    
    document.getElementById('scrollToBottom').addEventListener('click', function() {
      window.scrollTo({
        top: document.body.scrollHeight,
        behavior: 'smooth'
      });
    });
  </script>

    </body>
</html>